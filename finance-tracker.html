<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker - SG 2026</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&display=swap');
        :root { --bg: #0C1220; --card: #111D2E; --border: #1B2A3D; --accent: #339AF0; --text: #E2E8F0; --text-dim: #8A9BB5; --pos: #51CF66; --neg: #FF6B6B; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .logo { font-size: 20px; font-weight: 800; color: var(--accent); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; }
        .label { font-size: 10px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .val { font-size: 24px; font-weight: 800; }
        .sub-val { font-size: 12px; margin-top: 4px; color: var(--text-dim); }
        .rec-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .rec-item:last-child { border-bottom: none; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; background: rgba(51, 154, 240, 0.1); color: var(--accent); }
        input { width: 100%; padding: 12px; margin: 10px 0; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: white; }
        button { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .chart-container { height: 250px; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th { text-align: left; color: var(--text-dim); padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        td { padding: 10px 0; border-bottom: 1px solid rgba(27,42,61,0.4); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const CARD_DB = {
            "DBS Live Fresh": { min: 600, categories: ["Online Services", "Dining", "Shopping"], rate: 0.05 },
            "OCBC 365": { min: 800, categories: ["Dining", "Groceries", "Transport", "Petrol"], rate: 0.06 },
            "UOB One": { min: 500, categories: ["All"], rate: 0.033 },
            "HSBC Revolution": { min: 0, categories: ["Dining", "Online Services", "Travel"], rate: 0.04 },
            "Citi Cash Back+": { min: 0, categories: ["All"], rate: 0.016 }
        };

        const ChartComp = ({ data }) => {
            const ref = useRef(null);
            const chart = useRef(null);
            useEffect(() => {
                if (chart.current) chart.current.destroy();
                chart.current = new Chart(ref.current.getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#FF6B6B', '#339AF0', '#51CF66', '#FCC419', '#845EF7'], borderWidth: 0 }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' }
                });
            }, [data]);
            return <canvas ref={ref} />;
        };

        function App() {
            const [sid, setSid] = useState(localStorage.getItem("ft_sid") || "");
            const [apiKey, setApiKey] = useState(localStorage.getItem("ft_key") || "");
            const [isSetup, setIsSetup] = useState(!localStorage.getItem("ft_sid"));
            const [txns, setTxns] = useState([]);

            const parseDate = (str) => {
                const parts = str.split(' ')[0].split('/');
                return new Date(parts[2], parts[1] - 1, parts[0]);
            };

            const fetchData = async () => {
                try {
                    const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/Transactions?key=${apiKey}`);
                    const json = await res.json();
                    if (json.values) {
                        const parsed = json.values.slice(1).map(r => ({
                            date: parseDate(r[0]), merchant: r[3], amount: parseFloat(r[4].replace(/,/g, '')),
                            cat: r[5], type: r[10] || 'spending'
                        })).filter(t => !isNaN(t.amount));
                        setTxns(parsed);
                    }
                } catch (e) { console.error(e); }
            };

            useEffect(() => { if(!isSetup) fetchData(); }, [isSetup]);

            const stats = useMemo(() => {
                const now = new Date(2026, 1, 19); // Today based on your data
                const mtd = txns.filter(t => t.date.getMonth() === now.getMonth() && t.date.getFullYear() === now.getFullYear());
                const ytd = txns.filter(t => t.date.getFullYear() === now.getFullYear());

                const calc = (list) => ({
                    spend: _.sumBy(list.filter(t => t.type === 'spending'), 'amount'),
                    income: _.sumBy(list.filter(t => t.type === 'income'), 'amount')
                });

                const catBreakdown = _.mapValues(_.groupBy(mtd.filter(t => t.type === 'spending'), 'cat'), l => _.sumBy(l, 'amount'));
                
                // Card Recommendations logic
                const recs = Object.entries(CARD_DB).map(([name, cfg]) => {
                    let potential = 0;
                    Object.entries(catBreakdown).forEach(([c, val]) => {
                        if (cfg.categories.includes(c) || cfg.categories.includes("All")) potential += val * cfg.rate;
                    });
                    return { name, potential, meetsMin: (cfg.min <= calc(mtd).spend) };
                }).sort((a,b) => b.potential - a.potential);

                // Leakage detection
                const leakages = Object.entries(_.groupBy(txns, 'merchant'))
                    .map(([m, l]) => ({ m, count: l.length, total: _.sumBy(l, 'amount') }))
                    .filter(x => x.count >= 2 && x.total > 20 && x.m !== 'DBS Bank Ltd')
                    .sort((a,b) => b.total - a.total);

                return { mtd: calc(mtd), ytd: calc(ytd), catBreakdown, recs, leakages };
            }, [txns]);

            if (isSetup) return (
                <div style={{display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh'}}>
                    <div className="card" style={{width: '350px'}}>
                        <div className="logo" style={{marginBottom: '20px'}}>Finance Engine</div>
                        <input value={sid} onChange={e => setSid(e.target.value)} placeholder="Sheet ID" />
                        <input value={apiKey} type="password" onChange={e => setApiKey(e.target.value)} placeholder="API Key" />
                        <button style={{width: '100%'}} onClick={() => { localStorage.setItem("ft_sid", sid); localStorage.setItem("ft_key", apiKey); setIsSetup(false); }}>Connect</button>
                    </div>
                </div>
            );

            return (
                <div className="container">
                    <header className="header">
                        <div className="logo">Finance Dashboard <span style={{fontSize: '11px', color: 'var(--text-dim)'}}>FEB 2026</span></div>
                        <button style={{background: 'var(--card)', border: '1px solid var(--border)', fontSize: '11px'}} onClick={() => setIsSetup(true)}>CONFIGURE</button>
                    </header>

                    <div className="grid">
                        <div className="card">
                            <div className="label">Month to Date Spend</div>
                            <div className="val" style={{color: 'var(--neg)'}}>${stats.mtd.spend.toFixed(2)}</div>
                            <div className="sub-val">Income: <span style={{color: 'var(--pos)'}}>${stats.mtd.income.toFixed(2)}</span></div>
                        </div>
                        <div className="card">
                            <div className="label">Year to Date Spend</div>
                            <div className="val">${stats.ytd.spend.toFixed(2)}</div>
                            <div className="sub-val">Net: ${(stats.ytd.income - stats.ytd.spend).toFixed(2)}</div>
                        </div>
                        <div className="card">
                            <div className="label">Top Category</div>
                            <div className="val">{Object.keys(stats.catBreakdown)[0] || 'N/A'}</div>
                            <div className="sub-val">Largest outflow this month</div>
                        </div>
                    </div>

                    <div className="grid" style={{gridTemplateColumns: '1.2fr 1.8fr'}}>
                        <div className="card">
                            <div className="label">Spend Breakdown</div>
                            <div className="chart-container"><ChartComp data={stats.catBreakdown} /></div>
                            <div style={{marginTop: '15px'}}>
                                {Object.entries(stats.catBreakdown).map(([c, v]) => (
                                    <div key={c} style={{display: 'flex', justifyContent: 'space-between', fontSize: '12px', padding: '4px 0'}}>
                                        <span>{c}</span><span style={{fontWeight: 700}}>${v.toFixed(2)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="card">
                            <div className="label">Smart Card Optimizer</div>
                            <p style={{fontSize: '11px', color: 'var(--text-dim)', marginBottom: '15px'}}>Based on your MTD spending patterns:</p>
                            {stats.recs.slice(0,4).map(r => (
                                <div key={r.name} className="rec-item">
                                    <div>
                                        <div style={{fontSize: '14px', fontWeight: 700}}>{r.name}</div>
                                        <div style={{fontSize: '11px', color: r.meetsMin ? 'var(--pos)' : 'var(--neg)'}}>
                                            {r.meetsMin ? '✓ Min spend met' : '× Below min spend'}
                                        </div>
                                    </div>
                                    <div style={{textAlign: 'right'}}>
                                        <div className="badge">+${r.potential.toFixed(2)} back</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="grid">
                        <div className="card">
                            <div className="label">Leakage Alerts (Recurring/High Freq)</div>
                            <table>
                                <thead><tr><th>Merchant</th><th>Count</th><th>Total Drain</th></tr></thead>
                                <tbody>
                                    {stats.leakages.slice(0,5).map(l => (
                                        <tr key={l.m}>
                                            <td>{l.m}</td>
                                            <td>{l.count}x</td>
                                            <td style={{fontWeight: 700}}>${l.total.toFixed(2)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
