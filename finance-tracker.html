<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker - SG 2026</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;800&display=swap');
        
        :root {
            --bg: #0C1220;
            --card: #111D2E;
            --border: #1B2A3D;
            --accent: #339AF0;
            --text: #E2E8F0;
            --text-dim: #8A9BB5;
        }

        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'DM Sans', sans-serif;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }
        
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px;
        }

        .logo { font-size: 22px; font-weight: 800; color: var(--accent); }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .card { 
            background: var(--card); border: 1px solid var(--border); 
            border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .kpi-card { text-align: left; }
        .kpi-label { font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }
        .kpi-value { font-size: 28px; font-weight: 800; margin-top: 5px; }

        input { 
            width: 100%; padding: 14px; margin: 10px 0; background: var(--bg); 
            border: 1px solid var(--border); border-radius: 10px; color: white; outline: none;
        }

        button { 
            padding: 12px 24px; background: var(--accent); color: white; 
            border: none; border-radius: 10px; font-weight: 700; cursor: pointer;
        }

        .table-wrap { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; font-size: 11px; text-transform: uppercase; color: var(--text-dim); padding: 12px; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid rgba(27,42,61,0.5); font-size: 14px; }
        
        .neg { color: #FF6B6B; }
        .pos { color: #51CF66; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Visual helper for charts
        const ChartComponent = ({ data }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (chartRef.current) chartRef.current.destroy();
                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            data: Object.values(data),
                            backgroundColor: ['#FF6B6B', '#339AF0', '#51CF66', '#FCC419', '#845EF7', '#ADB5BD'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { plugins: { legend: { position: 'bottom', labels: { color: '#8A9BB5', usePointStyle: true } } }, cutout: '70%' }
                });
            }, [data]);

            return <canvas ref={canvasRef} />;
        };

        function App() {
            const [sid, setSid] = useState(localStorage.getItem("ft_sid") || "");
            const [apiKey, setApiKey] = useState(localStorage.getItem("ft_key") || "");
            const [isSetup, setIsSetup] = useState(!localStorage.getItem("ft_sid"));
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(false);

            const fetchData = async () => {
                if (!sid || !apiKey) return;
                setLoading(true);
                try {
                    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sid}/values/Transactions?key=${apiKey}`;
                    const res = await fetch(url);
                    const json = await res.json();
                    if (json.values) {
                        const rows = json.values.slice(1).map(r => ({
                            date: r[0], merchant: r[3], amount: parseFloat(r[4]) || 0, category: r[5] || 'Others'
                        }));
                        setData(rows);
                    }
                } catch (e) { console.error("Error fetching data", e); }
                setLoading(false);
            };

            useEffect(() => { if (!isSetup) fetchData(); }, [isSetup]);

            const totals = data.reduce((acc, curr) => {
                acc.total += curr.amount;
                acc.cats[curr.category] = (acc.cats[curr.category] || 0) + curr.amount;
                return acc;
            }, { total: 0, cats: {} });

            if (isSetup) {
                return (
                    <div className="container" style={{display: 'flex', justifyContent: 'center'}}>
                        <div className="card" style={{width: '400px', marginTop: '10vh'}}>
                            <div className="logo" style={{marginBottom: '20px'}}>Finance Engine</div>
                            <label className="kpi-label">Google Sheet ID</label>
                            <input value={sid} onChange={e => setSid(e.target.value)} placeholder="Enter Sheet ID" />
                            <label className="kpi-label">API Key</label>
                            <input value={apiKey} type="password" onChange={e => setApiKey(e.target.value)} placeholder="Enter API Key" />
                            <button onClick={() => { localStorage.setItem("ft_sid", sid); localStorage.setItem("ft_key", apiKey); setIsSetup(false); }}>Launch App</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <header className="header">
                        <div className="logo">Finance Tracker <span style={{fontSize: '12px', color: 'var(--text-dim)'}}>v2026</span></div>
                        <button style={{background: 'var(--card)', border: '1px solid var(--border)'}} onClick={() => setIsSetup(true)}>Settings</button>
                    </header>

                    <div className="kpi-grid">
                        <div className="card kpi-card">
                            <div className="kpi-label">Total Spending</div>
                            <div className="kpi-value">${totals.total.toFixed(2)}</div>
                        </div>
                        <div className="card kpi-card">
                            <div className="kpi-label">Transactions</div>
                            <div className="kpi-value">{data.length}</div>
                        </div>
                    </div>

                    <div style={{display: 'grid', gridTemplateColumns: '1.5fr 1fr', gap: '20px'}}>
                        <div className="card">
                            <div className="kpi-label">Recent Transactions</div>
                            <div className="table-wrap">
                                <table>
                                    <thead><tr><th>Date</th><th>Merchant</th><th>Amount</th></tr></thead>
                                    <tbody>
                                        {data.slice(0, 8).map((t, i) => (
                                            <tr key={i}>
                                                <td>{t.date}</td>
                                                <td style={{fontWeight: 600}}>{t.merchant}</td>
                                                <td className="neg">-${t.amount.toFixed(2)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="card">
                            <div className="kpi-label">Category Breakdown</div>
                            <div style={{marginTop: '20px'}}><ChartComponent data={totals.cats} /></div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
